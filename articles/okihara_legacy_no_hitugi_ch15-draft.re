== 第15章: A Clean Start

新幹線の窓から見える景色は、梅雨明け後の夏の色をしていた。

瀬川透はラップトップバッグを膝に載せて、一人で指定席に座っている。都心から約二時間。乗り換え一回。温泉街の名前は三週間前のメールで門倉律から教えてもらった。

『八月最初の土曜日なら、時間が取れます。小さなカフェがあるので、そこで会えませんか』

メールはそれだけだった。絵文字も装飾もない。門倉のコードと同じように簡潔で、必要なことだけが書かれている。

瀬川はバッグの中のラップトップを無意識に確認した。processor_test.goが入っている。三ヶ月前に書いたテスト。門倉が四年間で一度も見ることのなかったファイル。見せたかった。

窓の外に山が見えた。

//hr

カフェ「珈琲 まるせ」は、駅から歩いて十五分ほどの温泉街の外れにあった。

古い木造の建物を改装したらしい。手書きの小さな看板。引き戸を開けると、コーヒーの香りが漂ってきた。木の床が足音を柔らかく吸収する。天井は低く、照明は暖色系で落ち着いている。

カウンターに一人、窓際に三人。奥の席に、門倉律がいた。

社員名簿の証明写真より痩せている。頬が削げ、顎のラインが鋭い。髪は無造作で、整髪料の類は使っていないようだった。目には——光があった。四年と三ヶ月が削り取った男。しかし死んではいない。

瀬川を見つけて、門倉が小さく手を挙げた。

「瀬川さんですか」

低く落ち着いた声。

「門倉さん。はじめまして」

三週間コードを読み続け、truth.txtを何度も読み返した。しかし面と向かうのは初めてだ。

握手。門倉の手は冷たいが、握る力はしっかりしていた。

二人は向かい合って座った。

店員がメニューを持ってくる。二人ともブレンドを頼んだ。

しばらく無言だった。

何から話せばいいか、二人ともわからない。

蝉の声が聞こえる。窓の外は夏の光に満ちている。カウンターでは店主が豆を挽く音が静かに響いている。

コーヒーが運ばれてきた。

瀬川が一口飲む。深い苦味と、かすかな酸味。

門倉も飲んだ。小さく頷く。

「processor.go のテスト、見ましたよ」

門倉が口を開いた。

「黒木さんがログを送ってくれた。あなたが書いた最初のテスト。三ヶ月前の」

「読みにくいコードでした」

瀬川は率直に答えた。遠慮は不要だと思った。

門倉がかすかに笑った。

「当然だ。読みにくく書いた」

テーブルの上でコーヒーカップが小さく音を立てた。

門倉が窓の外を見る。

「四年間、あのコードを書いた」

静かな声。

「最初の半年はまともなコードでした。テストもコメントもGoの標準スタイルで書いていた。それが普通だと思っていたから」

七ヶ月目。

「荻野に呼ばれて、全てが変わった」

門倉は遠くを見るような目をしていた。

「データを取れ、と言われた。ユーザーの行動を全部記録しろ、と。まだ試用期間中だよね、と笑顔で言われた」

「truth.txtで読みました」

門倉が視線を戻した。

「難読化は——自己防衛だった。恥ずかしかった。同時に、証拠を残したかった」

門倉はコーヒーカップを両手で包むようにして持った。

「隠したい。でも見つけてほしい。逃げたい。でも終わらせたい。四年間、その矛盾の中で書いた」

瀬川は黙って聞いた。

「あのコードは何でしたか。門倉さんにとって」

長い沈黙。

蝉の声が遠くから響いている。窓の外の夏の午後の光が、テーブルの縁を照らしている。

「あのコードは——」

門倉の声が途切れた。

もう一度息を吸って、言葉を継いだ。

「俺の棺だった」

静かな言葉だった。

力まず、淡々と。確実に。

「証拠をコードの中に閉じ込めた。自分自身ごと。恐怖も罪悪感も僅かな希望も、全部一緒に」

門倉がコーヒーを飲んだ。

「あなたが開けてくれた」

瀬川はカップを置いた。

「暗号鍵を仕込んだ時、思った」

門倉が続けた。

「もし俺が消えても、証拠は残る。正しい人間が来れば必ず見つけてくれる」

「リファクタリングできる人間だけが見つけられる」

門倉が頷いた。

「技術的能力の話じゃない。コードに対する姿勢の問題だ」

瀬川は頷いた。truth.txtに書かれていたその言葉を、いま門倉の口から直接聞いた。

「『動いてるから触るな』を真に受ける人間には見えない。でも本当にコードを読もうとする人間には——見える」

門倉がまっすぐ瀬川を見た。

「ありがとう。読んでくれたんだな」

瀬川は何も答えなかった。答える必要がなかった。

//hr

瀬川はバッグからラップトップを取り出した。

「見せたいものがあります」

電源を入れる。起動を待つ間、門倉は静かに座っている。

ログイン。BridgeFlowのリポジトリを開く。事件後に瀬川が切ったブランチ。

@<tt>{feature/refactor-legacy-core}

processor_test.go。

瀬川が画面を門倉の方に向けた。

門倉が画面を覗き込む。

Table-Driven Test。入力と期待値が整然と並んでいる。テストケース名は英語で明確に。コメントは必要な部分に簡潔に。

門倉がスクロールした。

processor.go。変数名が読める。@<tt>{xR} は @<tt>{TransformPayload} になっている。@<tt>{kF} は @<tt>{GenerateKey}。@<tt>{mT} は @<tt>{timestamp}。

コメント:

//emlist[][go]{
// Previously named 'xR' - renamed for clarity
//}

門倉の目が潤んだ。

「テストがある」

声が震える。

「コメントがある」

ゆっくりとスクロール。

「変数名が——読める」

「当たり前です」

瀬川の言葉。

門倉が画面から目を離して、瀬川を見た。

「俺が四年間で壊したものを、あなたが直してくれるのか」

「一人で壊したわけじゃないでしょう。壊されたんだ。荻野に」

瀬川はラップトップを自分の前に戻した。

「全部書き直しましょう。今度はテストと一緒に」

門倉は黙っていた。

「ああ」

小さく頷いた。

「今度はちゃんとコメントも書く」

「変数名もまともにしてくださいね。@<tt>{xR}とか@<tt>{kF}とか、二度と見たくない」

門倉が初めて笑った。

「悪かった。途中から自分でも整理できなくなっていた」

瀬川も笑った。

カウンターの店主が二人の方を不思議そうに見た。

「秋頃には東京に戻りたい」

門倉が言った。

「コードの後片付けは、書いた人間がやるべきだ」

瀬川はラップトップを閉じた。

「待ってます」

//hr

十月末の金曜日、夜。

クラウドブリッジ本社七階。

四ヶ月が経っていた。

黒木が代表取締役に就任し、外部監査を導入した。椎名がインフラチームのリーダーになった。佐々木は藤堂の法律事務所から正式に移籍し、社内セキュリティ勉強会を企画している。三島は新しい経理部長の下で穏やかに働いている。

そして門倉律が、嘱託アドバイザーとして復帰した。

週三日出社。藤堂の法律事務所が復帰の法的整理を担当し、被害者としての立場が明確化された。

深夜のオフィス。

もう怖くない。

@<tt>{.bf_monitor} は削除済みだ。荻野の穏やかな笑顔も、もう二度と現れない。

瀬川と門倉が並んでキーボードを叩いている。

@<tt>{/legacy/core/} の書き直し。

十万行のうち約二万行がこのディレクトリに集中している。門倉の棺。

「新しいブランチを切ろう」

瀬川が言った。

門倉が頷いた。

//emlist[][bash]{
git checkout -b feature/rewrite-legacy-core
//}

//emlist{
Switched to a new branch 'feature/rewrite-legacy-core'
//}

最初のファイル: @<tt>{processor.go}

門倉の旅が始まった場所。瀬川の旅が始まった場所。

「テストを書こう」

瀬川がファイルを新規作成した。

//emlist[][bash]{
touch legacy/core/processor_test.go
//}

門倉が隣で画面を見ている。

Table-Driven Test。@<tt>{TestTransformPayload}。

瀬川が入力データと期待値のテーブルを書く。門倉が「そのケースも追加した方がいい」と指摘する。

テストが完成した。

//emlist[][bash]{
go test ./legacy/core/... -run TestTransformPayload
//}

@<b>{Red}.

//emlist{
--- FAIL: TestTransformPayload (0.00s)
    processor_test.go:42: function TransformPayload not found
FAIL
//}

当然だ。@<tt>{TransformPayload} はまだ存在しない。@<tt>{xR} という名前の関数があるだけだ。

「実装を書こう」

門倉が processor.go を開いた。

@<tt>{xR} の定義を見つける。

「この関数名を変える」

//emlist[][go]{
// func xR(d []byte) ([]byte, error) {
func TransformPayload(data []byte) ([]byte, error) {
//}

変数名の翻訳。

@<tt>{d} → @<tt>{data}

@<tt>{r} → @<tt>{result}

@<tt>{e} → @<tt>{err}

暗号を自然言語に翻訳する作業。

四年間の暗闇に光を当てる作業。

門倉がキーボードを叩く。瀬川が横で見守る。

「@<tt>{kF} は？」

「@<tt>{GenerateKey}」

「@<tt>{mT} は？」

「@<tt>{timestamp}」

「@<tt>{pR}は？」

「@<tt>{ProcessRequest}」

一行一行。

@<tt>{bV} 関数を削除する。

//emlist[][go]{
// func bV(uid int64, act string, ts int64) error {
//     // INSERT INTO _shadow_logs ...
// }
// Removed: This function was used for unauthorized data collection
//}

@<tt>{_shadow_logs} にデータを書き込む関数。二度と動くことはない。

コメントを残す。

//emlist[][go]{
// Previously named 'xR' - renamed for clarity
//}

消すのではなく、翻訳する。

門倉のコードの痕跡を残す。

歴史を否定するのではなく、変換する。

テスト実行。

//emlist[][bash]{
go test ./legacy/core/... -run TestTransformPayload
//}

@<b>{Green}.

//emlist{
PASS
ok      github.com/cloudbridge/bridgeflow/legacy/core   0.021s
//}

門倉が小さく息を吐いた。

「通った」

「次はリファクタリング」

瀬川が言った。

入れ子のロジックをフラットにする。不要な分岐を削除する。意味のある変数名に統一する。

門倉が時折「そこは元々こういう意図だった」と説明する。

四年前の自分のコードを客観的に見る穏やかな目。

一行一行、コードが呼吸を取り戻していく。

//hr

23:00。

最初のコミット。

//emlist[][bash]{
git add legacy/core/processor.go legacy/core/processor_test.go
git commit -m "Chapter 1: A clean start"
//}

//emlist{
[feature/rewrite-legacy-core 1a2b3c4] Chapter 1: A clean start
 2 files changed, 187 insertions(+), 342 deletions(-)
//}

@<tt>{187 insertions(+), 342 deletions(-)}

削除の方が多い。

不要なコードを削り、必要なテストを加えた。

コードは減ったが品質は上がった。

瀬川が git log を見た。

門倉の四年分のコミット。深夜のタイムスタンプ。

新しいコミットは過去の上に積み重なっている。

過去を消すのではなく、過去の上に未来を書く。

「@<tt>{Chapter 1}か」

門倉が画面を見て言った。

「全十五章くらいになる見込みです。各ファイルの書き直しを一章ずつ」

「長い旅になるな」

「急ぎません。一つずつ、テストと一緒に」

窓の外で夜が白み始めた。

十月最後の夜明け。東の空が薄い紫色に染まっている。

棺は開いた。

中身は日の光の下に晒された。

新しいコードが古い骨の上に積み上げられていく。

レガシーは消えない。

ただ変わるだけだ。

一行一行。

テストと一緒に。

「次は sync_agent.go だな」

瀬川が言った。

門倉が画面を見る。

「このファイルは——削除する」

//emlist[][bash]{
git rm legacy/core/sync_agent.go
//}

門倉が横で頷いた。

言葉は要らない。

あのコードは二度と動かない。

門倉がコーヒーを淹れに立った。

「飲むか？」

「お願いします」

深夜のオフィスに二人分のコーヒーの香りが漂う。

外の空が明るくなっている。

十月最後の土曜日の夜明け。

瀬川が次のファイルを開いた。

@<tt>{aggregator.go}

//emlist[][bash]{
touch legacy/core/aggregator_test.go
//}

新しいファイルが生成される。

門倉がコーヒーカップを二つ持って戻ってきた。

「ありがとうございます」

瀬川がカップを受け取った。

一口飲む。苦味と温かさ。

門倉が隣に座った。

画面には空の @<tt>{aggregator_test.go} が表示されている。

「最初のテストケースは？」

門倉が聞いた。

瀬川が考える。

「ユーザーIDでフィルタリングする処理から」

「いいな」

門倉が頷いた。

二人でキーボードを叩き始める。

窓の外、東京の空が明るくなる。

夜明けの光がモニターに反射する。

新しい歴史の、二番目のコミットが始まる。
