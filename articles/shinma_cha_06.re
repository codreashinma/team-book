= 第6章　見えない敵

//hr

　最初のメインネット・トランザクションは、失敗した。

　エラーメッセージはたった一行。

//emlist{
Error: insufficient funds for intrinsic transaction cost
//}

　ガス代が、足りない。

　蓮はモニターの前で固まった。テストネットでは何百回と成功した送金が、メインネットに切り替えた途端に動かない。理由は単純だった。テストネットのPOLはフォーセットから無限にもらえる。メインネットのPOLは、実際のお金で買わなければならない。

　プロトタイプが完成してから三日が経っていた。丘部との約束——白石を連れてねづ珈琲に来る——は来週に迫っている。テストネットのデモでは不十分だ。「本番環境で動いています」と言えなければ、丘部にも白石にも、ましてや根津にも、信用してもらえない。

　蓮は取引所のアカウントを開き、一万円ぶんのPOLを購入した。フリーランスの貯金を切り崩しての投資。手が震えた。テストネットでは感じなかった重力が、指先にかかっている。このPOLは本物だ。使えば減る。失敗すれば消える。

　POLがウォレットに着金したのを確認し、蓮はもう一度送金を試みた。

　MetaMaskのポップアップが表示された。「推定ガス代：0.008 POL」。日本円にして約〇・四円。テストネットで見ていた数字とほぼ同じだ。

　「確認」を押した。

　五秒。十秒。三十秒——

　ステータスが「確認済み」に変わった。

　通った。メインネットで、本物のJ-Coinが動いた。

　蓮は息を吐いた。しかし安堵は三十分しか続かなかった。

//hr

　二回目のテスト送金で、ガス代が跳ね上がった。

　「推定ガス代：0.15 POL」。

　蓮は目を疑った。三十分前の二十倍近い。MetaMaskの画面をリロードしても数字は変わらない。蓮はPolygonのガストラッカーを開いた。ネットワーク全体の混雑状況がリアルタイムで表示されるページだ。

　グラフが真っ赤だった。

　どこかの大型NFTプロジェクトがミントを開始したらしい。数万人が一斉にトランザクションを発行し、ネットワークが渋滞している。道路と同じだ。みんなが同時に走ろうとすると、通行料が上がる。

　〇・四円が八円になった。コーヒー一杯の手数料としてはまだ安い。しかし問題は金額ではなく、予測不能性だった。

　根津に「手数料はほぼゼロです」と説明したら、根津は「ほぼ」ではなく「ゼロ」を期待する。ところが実際には〇・四円の日もあれば八円の日もある。極端な場合、数十円に膨れ上がることもあり得る。蓮のアプリは手数料を「ガス代のみ」と謳っているが、そのガス代が乱高下するなら、根津にとっては「手数料が読めない決済」にすぎない。

　クレジットカードの手数料は高いが安定している。ブロックチェーンの手数料は安いが不安定。どちらが商売人にとって怖いかは、考えるまでもなかった。

//hr

　三回目のテスト送金で、別の問題が起きた。

　トランザクションを送信してから、二分経ってもステータスが「保留中」のままだった。テストネットでは二秒から十秒で完了していた処理が、メインネットでは沈黙している。

　蓮のアプリでは、店舗側が三秒ごとにポーリング——サーバーに問い合わせて決済完了を確認する——を行っている。プロトタイプ開発で実装した、あのシンプルな@<tt>{setInterval}だ。テストネットでは完璧に機能した。三秒後にはステータスが@<tt>{COMPLETED}に変わり、緑のチェックマークが灯った。

　しかしメインネットでは、ポーリングのたびに@<tt>{PENDING}が返ってくる。三秒。六秒。九秒。十二秒。客が店の前でスマートフォンを持ったまま二分間待たされる光景を想像して、蓮の胃が重くなった。

　根津の声が脳内で鳴る。

　「遅いな。壊れてんのか」

　さらに悪いシナリオがあった。トランザクションがブロックチェーン上では承認されたのに、蓮のサーバーがそれを検知できなかったら？　客のウォレットからJ-Coinは引かれている。しかし店舗側の画面はいつまでも「お支払い待ち」のまま。客は「払ったのに」と怒る。店は「受け取っていない」と困る。お金は宙に浮く。

　テストネットでは起こり得なかった。テストネットは空いていて、いつも高速で、蓮以外にほとんど誰も使っていなかったから。メインネットは違う。何百万人が同時に使い、ネットワークの状態は刻一刻と変わり、蓮のコントロールが及ばない力が四方八方から押し寄せる。

　テストネットは実験室。メインネットは台風の海だ。同じ船でも、プールと大洋では揺れ方が違う。

//hr

　四回目のテスト送金で、蓮は決定的な問題を発見した。

　スマートフォンのウォレットアプリを二種類試した。MetaMaskと、もう一つ別のウォレット。MetaMaskでは正常に動作するが、別のウォレットではネットワーク切り替えの挙動が異なり、Polygon Mainnetへの接続に失敗する。WalletConnectのプロトコルバージョンの差異。テストネットでは両方とも問題なく動いたのに。

　蓮はノートパソコンを閉じ、天井を見上げた。

　四回のテストで四つの問題が出た。ガス代の変動。トランザクション遅延。決済検知の信頼性。ウォレットの互換性。どれもテストネットでは影も形もなかった敵だ。見えない敵。実弾が飛ぶ戦場に出て、初めて姿を現す敵。

　蓮はDiscordを開いた。

//hr

　深夜十一時。kirishi_maのステータスはオンラインだった。この人はいつ寝ているのだろう、と蓮は思いながらDMを打った。

//quote{
@<b>{fujisaki_ren}: メインネット移行で詰まっています。テストネットでは完璧に動いていたのに、本番では問題だらけです。特にトランザクション検知の信頼性が不安で。今はポーリングで3秒ごとにステータスを確認してるんですが、メインネットだとトランザクション確認に時間がかかるケースがあって、検知漏れが怖いです。
//}

　返事は二分で来た。kirishi_maにしては長い沈黙だった。

//quote{
@<b>{kirishi_ma}: ポーリングだけで本番運用するのはやめたほうがいい。
//}

　一行目から、蓮の背筋が伸びた。

//quote{
@<b>{kirishi_ma}: ポーリングは「Pull型」——自分から聞きに行く方式だ。3秒ごとにサーバーに「まだ？ まだ？」と聞く。サーバーはRPCプロバイダ経由でブロックチェーンに問い合わせる。でもRPCプロバイダにはレート制限がある。問い合わせが多すぎるとブロックされる。複数の店舗が同時に決済を処理したら、リクエスト数が爆発する。

対策は「Push型」にすること。@<b>{Alchemy Webhook}を使え。
//}

　蓮はAlchemyの名前を知っていた。RPCプロバイダ——ブロックチェーンのノードに接続するための中継サービスだ。蓮のアプリもAlchemyのRPCエンドポイントを使ってPolygonに接続している。しかしWebhookは使ったことがなかった。

//quote{
@<b>{fujisaki_ren}: Webhookというのは、ブロックチェーン側からこっちに通知が来る仕組みですか？
//}

//quote{
@<b>{kirishi_ma}: そう。Alchemyのダッシュボードで「このアドレスへのERC-20トランザクションを監視してくれ」と設定する。トランザクションがブロックに取り込まれた瞬間、Alchemyが君のサーバーにHTTPリクエストを飛ばしてくる。君は待っているだけでいい。

ポーリングは「3秒ごとに郵便ポストを見に行く」。Webhookは「郵便屋さんがチャイムを鳴らしてくれる」。
//}

　蓮の頭の中で、設計が組み変わり始めた。

//quote{
@<b>{kirishi_ma}: ただし、Webhookだけに依存するのも危険だ。ネットワーク障害でWebhookが届かないケースもある。ベストプラクティスは両方を組み合わせること。Webhookで即座に検知し、ポーリングをフォールバックとして残す。ベルトとサスペンダー。
//}

　ベルトとサスペンダー。蓮はプロトタイプ開発中、二重決済防止の設計で自分も同じ比喩を使ったことを思い出して、少し笑った。

//quote{
@<b>{fujisaki_ren}: やってみます。Webhookのエンドポイントを実装して、Alchemyから通知を受け取るAPIルートを作ればいいんですね。
//}

//quote{
@<b>{kirishi_ma}: そう。あと一つ。Webhookのリクエストが本当にAlchemyから来たものかどうか、署名検証を必ず入れろ。Webhookのエンドポイントは公開URLだから、誰でもリクエストを送れる。悪意のある第三者が偽の「決済完了」通知を送ってきたら、アプリは嘘のトランザクションを正当と判断してしまう。
//}

　蓮の指がキーボードの上で止まった。

　偽の決済完了通知。考えたこともなかった。テストネットでは「誰が攻撃してくるか」なんて想像する必要がなかった。しかしメインネットには本物のお金が流れている。本物のお金があるところには、それを奪おうとする人間がいる。

//quote{
@<b>{kirishi_ma}: セキュリティの世界には「見えない敵を想定しろ」という原則がある。攻撃者は君のコードを読める。エンドポイントのURLを知っている。リクエストの形式も分かっている。「まさかそんなことはしないだろう」は、通用しない。
//}

//hr

　翌朝。蓮はAlchemyのダッシュボードを開いた。

　Webhookの設定画面。監視対象のアドレス、通知先のURL、トリガー条件を指定する。蓮は店舗のウォレットアドレスへのERC-20トランスファーをトリガーに設定し、通知先に自分のサーバーのエンドポイントを入力した。

　次に、APIルートを実装する。

//emlist[][typescript]{
// /api/webhook/alchemy
export async function POST(request: NextRequest) {
  const body: AlchemyWebhookEvent = await request.json();

  for (const activity of body.event.activity) {
    // J-Coinのコントラクトアドレスか検証
    if (activity.rawContract.address.toLowerCase()
        !== JPYC_CONTRACT_ADDRESS.toLowerCase()) {
      continue;
    }

    const txHash = activity.hash;
    const fromAddress = activity.fromAddress;
    const toAddress = activity.toAddress;
    const amount = activity.rawContract.rawValue;

    // 対応する決済リクエストを検索
    const paymentRequest = await prisma.paymentRequest.findFirst({
      where: {
        toAddress: { equals: toAddress, mode: 'insensitive' },
        status: 'PENDING',
        expiresAt: { gt: new Date() },
      },
    });

    if (!paymentRequest) continue;

    // 金額検証
    // ...

    // アトミックにDB更新
    await prisma.$transaction([
      prisma.transaction.create({
        data: { paymentRequestId: paymentRequest.id, txHash, fromAddress, toAddress, amount, status: 'CONFIRMED' },
      }),
      prisma.paymentRequest.update({
        where: { id: paymentRequest.id },
        data: { status: 'COMPLETED' },
      }),
    ]);
  }

  return NextResponse.json({ success: true });
}
//}

　chemy-signature`という署名が含まれる。サーバー側でこの署名を検証すれば、リクエストが本当にAlchemyから送られたものかどうかを確認できる。

typescriptWebhookが届くたびに、Alchemyから送られてきたイベントを解析する。トランザクションのコントラクトアドレスがJ-Coinのものか確認し、対応する決済リクエストを検索し、金額を検証し、データベースを更新する。

　ポーリングでは蓮のサーバーが三秒ごとに聞きに行っていた。Webhookでは、ブロックチェーン上でトランザクションが承認された瞬間にAlchemyが知らせてくれる。聞きに行く必要がない。待っていれば、答えが飛んでくる。

　しかし——

　霧島の警告が頭をよぎった。署名検証。

　蓮はAlchemyのドキュメントを読んだ。Webhookリクエストのヘッダーに`x-al

//emlist{
import crypto from 'crypto';

function verifyAlchemySignature(
  payload: string,
  signature: string,
  signingKey: string
): boolean {
  const hmac = crypto.createHmac('sha256', signingKey);
  hmac.update(payload);
  const digest = hmac.digest('hex');
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(digest)
  );
}
//}

　HMAC-SHA256。リクエストボディと秘密鍵からハッシュを計算し、Alchemyが送ってきた署名と照合する。一文字でも違えば、偽造だと分かる。@<tt>{timingSafeEqual}を使うのは、タイミング攻撃——比較にかかる時間の微細な差を利用して署名を推測する手法——を防ぐためだ。

　テストネットでは「動くかどうか」だけを考えていればよかった。メインネットでは「壊されないかどうか」も考えなければならない。コードの行数はさほど増えないのに、一行あたりの重みがまるで違う。

//hr

　三時間後。

　蓮はメインネットでWebhookのテストを完了した。J-Coinを送金すると、数秒後にAlchemyからWebhookが届き、サーバーがトランザクションを検証し、決済リクエストのステータスが@<tt>{COMPLETED}に切り替わる。ポーリングだけのときより圧倒的に速く、確実だった。

　フォールバックのポーリングも残した。Webhookが五秒以内に届かなかった場合にのみ、従来の三秒間隔のポーリングが作動する。ベルトとサスペンダー。

　蓮はDiscordに報告した。

//quote{
@<b>{fujisaki_ren}: Webhook実装できました。署名検証も入れました。メインネットで動作確認済みです。
//}

//quote{
@<b>{kirishi_ma}: 早いな。

ちなみに、もう一つ見えない敵を教えておく。君のアプリは直接スマートコントラクトを書いているわけじゃないから、リエントランシー攻撃のリスクは低い。でもWebhookのエンドポイントに対する@<b>{リプレイ攻撃}は意識しておけ。同じWebhookイベントが二度届いたときに、二度処理しないこと。
//}

　蓮はコードを見返した。@<tt>{txHash}に@<tt>{@unique}制約をかけている。同じトランザクションハッシュで二度@<tt>{Transaction}を作ろうとすれば、データベースがエラーを返す。第五章で設計した二重支払い防止の壁が、ここでも蓮を守っていた。

//quote{
@<b>{fujisaki_ren}: txHashのユニーク制約で防いでいます。
//}

//quote{
@<b>{kirishi_ma}: いいね。

あと、丘部さんから聞いたんだけど、来週白石さんと一緒にねづ珈琲に行くんだって？
//}

//quote{
@<b>{fujisaki_ren}: はい。白石さんって、法務の方ですよね。
//}

//quote{
@<b>{kirishi_ma}: ああ。白石さんの話は、ちゃんと聞いておいたほうがいい。技術的な問題は君のレベルなら解ける。でも法律の問題は、エンジニアだけでは解けない。
//}

　蓮は「技術的な問題は君のレベルなら解ける」という部分を二度読んだ。kirishi_maに認められた——そう思った直後、後半の文が重くのしかかった。

　法律の問題。

//hr

　来週の火曜日。午後三時。

　ねづ珈琲のドアを開けると、カウンターに二つの見慣れない背中があった。

　丘部典孝と、その隣に座る女性。三十代前半。黒のジャケットにグレーのインナー。髪を一つに結び、銀縁のメガネの奥の目が鋭い。カウンターに置かれたカップに、まだ口をつけていない。

「蓮くん、来たね」

　丘部が振り向いた。穏やかな笑顔。蓮はその隣の女性に目を移した。

「紹介するよ。白石楓さん。うちの法務・コンプライアンス責任者」

　白石は椅子から立ち上がり、名刺を差し出した。

「白石です。丘部からプロジェクトの話は聞いています」

　声は低く、落ち着いていた。名刺の肩書には「法務・コンプライアンス責任者」とあり、その下に小さく「元金融庁」の文字。蓮の指が、名刺を持ったまま止まった。

　金融庁。規制する側にいた人間が、規制される側に移った。

「まず、アプリを見せてもらえますか」

　白石は蓮が座る前にそう言った。丘部が苦笑する。「白石さんは結論が早いんだ」。

　蓮はタブレットを取り出し、デモを始めた。テンキーで「500」を入力。QRコードが表示される。スマートフォンでスキャン。ウォレット接続。送金。数秒後、Alchemyからの Webhookを受けて、タブレットの画面が青から緑に変わった。

　「決済完了」。

　根津がカウンターの向こうから覗き込んでいた。丘部が根津に向かって「これ、蓮くんが作ったんですよ」と言い、根津が「ふうん」と腕を組んだ。その表情を読む余裕は蓮にはなかった。白石の目が、蓮のタブレットの画面に釘付けになっていたからだ。

「技術的にはよくできていますね」

　白石の第一声だった。蓮は少しだけ肩の力を抜いた。

「ただ——」

　力が戻った。

「藤崎さん。一つ聞いてもいいですか。このアプリで、あなたはユーザーの資金を預かりますか？」

「いいえ。J-Coinは客のウォレットから店舗のウォレットに直接送金されます。僕のサーバーは決済リクエストを管理しているだけで、資金には一切触れません」

「それは良い設計です。では次の質問。あなたのアプリを使うために、ユーザーは本人確認——KYCを完了する必要がありますか？」

「えっと……今の実装では、店舗側はメールアドレスとウォレットアドレスの登録だけで使えます。客側はウォレットを持っていれば誰でも——」

「止まってください」

　白石の声は静かだったが、蓮の言葉を正確に遮った。

「資金決済法と犯罪収益移転防止法の観点から、いくつか整理が必要です」

　白石はカバンからA4のクリアファイルを取り出した。中には印刷された資料が入っている。蓮は、白石がこのために資料を準備してきたことに気づいた。丘部から事前に聞いていたのだ。

「まず前提の確認です。J-Coin自体は、ジェイコイン・ラボが資金決済法に基づいて発行している『電子決済手段』です。発行体としての規制要件——信託保全、当局への届出、AML/CFT体制——はすべてラボ側でクリアしています」

　丘部が隣で頷く。

「しかし、問題はここからです。J-Coinの上で動くアプリケーション——藤崎さんのQRコード決済アプリのようなもの——を提供する場合、そのアプリが法律上どういう立ち位置になるのかを整理しなければなりません」

「立ち位置……？」

「たとえば、あなたのアプリが『電子決済手段等取引業者』に該当するかどうか。該当すれば、金融庁への登録が必要になります」

　蓮の口が乾いた。金融庁への登録。フリーランスのエンジニアが、金融庁に登録する。

「えっと、僕のアプリは単にQRコードを生成して、ウォレットの接続を仲介しているだけです。J-Coinの売買や交換は行っていません」

「そこが論点です」

　白石はメガネの位置を直した。

「あなたのアプリが『売買・交換の媒介』に当たらなくても、決済の仲介や利用者の管理を行っている場合、別の規制が及ぶ可能性があります。これはケースバイケースの判断で、一概に白黒つけられない」

　蓮は黙った。コードなら、コンパイラが白黒を教えてくれる。動くか動かないか。エラーか成功か。しかし法律の世界には「グレーゾーン」がある。グレーは、エンジニアが最も苦手とする色だ。

「脅かしたいわけじゃありません」

　白石の声が、わずかに柔らかくなった。

「ただ、知らなかったでは済まされないのが法律です。あなたのアプリの設計思想は正しい。資金を預からない。直接送金を仲介するだけ。その方向性であれば、規制上のリスクは最小限に抑えられます。でも、それを『法的に説明できる状態』にしておく必要がある」

　丘部が口を開いた。

「蓮くん、僕らも同じ道を通ってきた。J-Coinを作り始めたとき、コードは三ヶ月で書けた。でも法律の整理に一年かかった。技術と法律は車の両輪だ。片方だけでは、どこにも行けない」

　根津がカウンターの向こうで黙って聞いていた。会話の半分も分かっていないだろう。しかし「金融庁」「法律」という単語は聞こえたはずだ。根津の表情が、少し硬くなっている。

「白石さん」

　蓮は、自分でも驚くほど落ち着いた声で言った。

「僕はどうすればいいですか」

　白石は一瞬、蓮の顔を見つめた。それから、わずかに口角を上げた。初めて見る笑顔だった。

「まず、あなたのアプリのサービス設計を書面で整理してください。誰が何の役割を担い、資金の流れはどうなっているか。それを私に見せてくれれば、法的な論点を洗い出して、対応策を一緒に考えます」

「……ありがとうございます」

「お礼は要りません。こういうアプリが出てくることが、エコシステムにとって一番大事なんです。芽を摘みたいんじゃない。ちゃんと育てたいんです」

　丘部が嬉しそうに笑った。「白石さん、今のいい台詞だったね」。白石は「うるさい」と返した。

//hr

　夜。蓮は自室のデスクに向かっていた。

　モニターには二つのウィンドウが開いている。左はVS Code。Webhookの実装コード。右はテキストエディタ。白石に見せるためのサービス設計書。

　左のウィンドウは、ほぼ完成している。Alchemy Webhookによるリアルタイム検知。署名検証。リプレイ攻撃対策。ポーリングのフォールバック。ガス代の変動はまだ完全には解決していないが、Polygonの平均ガス代を表示するUIを追加し、異常に高い場合は警告を出す仕組みを入れた。

　右のウィンドウは、白紙だった。

　蓮はサービス設計書の最初の一行を書いた。

//emlist{
【サービス概要】
本アプリは、J-Coin（電子決済手段）を利用した
店舗向けQRコード決済アプリケーションです。
//}

　手が止まった。

　次に何を書けばいいのか分からない。「資金の流れ」を図にする？　「法的な立ち位置」を宣言する？　プログラミングなら、分からなければドキュメントを読めばいい。しかし法律の「ドキュメント」は、@<tt>{e-Gov}の法令検索で原文を読んでも、エンジニアの目には暗号にしか見えなかった。

　蓮はDiscordを開き、kirishi_maの言葉を思い出した。

　「技術的な問題は君のレベルなら解ける。でも法律の問題は、エンジニアだけでは解けない」

　今日、白石は手を差し伸べてくれた。「一緒に考えます」と言ってくれた。エコシステムとは、コードを共有するだけではない。法律の知見も、ビジネスの経験も、商売人の直感も、すべてを持ち寄って一つのプロダクトを育てる営みだ。

　蓮は右のウィンドウに向き直り、二行目を書いた。

//emlist{
【資金フロー】
本アプリは利用者の資金を預からない。
//}

　たった一行。しかしこの一行が、蓮のアプリを法的に守る盾になるかもしれない。

　蓮は三行目を書き始めた。窓の外は暗い。モニターの明かりだけが、デスクの上のノートを照らしている。ノートの左ページには技術のメモ。右ページには法律のメモ。コントラクトのコードを初めて読んだあの夜と同じ構図だ。あのときは「渡るべき川は見えた」と思った。

　今は川が二本になった。

　技術という川と、法律という川。どちらも渡らなければ、根津の前に立てない。

　蓮はコーヒーを一口飲んだ。今日、根津がカウンターの向こうで聞いていた表情が浮かぶ。不安と、少しだけ期待が混じった顔。あの顔を安心に変えるために、蓮はコードも法律も書く。

　モニターの左側で、Webhookのテストログが流れている。Alchemyからの通知が正常に処理されたことを示す@<tt>{200 OK}の文字列。見えない敵は、まだどこかに潜んでいるかもしれない。しかし蓮にはもう、敵の姿を見つける目と、味方の力を借りる知恵がある。

　サービス設計書の四行目を書く。五行目を書く。

　夜が明けるまでに、まだ時間はあった。
