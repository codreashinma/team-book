=== 第03章: _shadow_logs

月曜日。入社二週目の朝。

瀬川は出社して最初にエディタを開き、空のテストファイルを作った。

//emlist[][go]{
// processor_test.go
package core

import "testing"
//}

テストを書く。それが出発点だった。

二千行の難読化コードに正面から挑んでも勝ち目はない。だがテストは違う。関数に入力を与え、出力を観測する。中身がどれほど難読化されていても、入力と出力の関係は嘘をつけない。テストはコードに問いを投げる。コードは、嘘のない答えを返すしかない。

@<tt>{processor.go} の @<tt>{Execute} 関数。引数は @<tt>{[]byte} と @<tt>{map[string]string}。戻り値は @<tt>{([]byte, error)}。まず最小の入力を与える。空のバイト列と空のマップ。

//emlist[][go]{
func TestExecute_EmptyInput(t *testing.T) {
    result, err := Execute([]byte{}, map[string]string{})
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
    t.Logf("result length: %d", len(result))
}
//}

テストを走らせた。通る。結果は空のバイト列。関数は空の入力に対して空を返す。当然の結果に見えるが、これが最初のアンカーポイントになる。

次に、入力のバイト列を変化させる。短い文字列をバイト列として渡す。結果のバイト列の長さが変わる。入力十バイトに対して結果は三十二バイト。二十バイトに対して六十四バイト。三十バイトに対して九十六バイト。比例関係。入力の長さの約三・二倍が出力される。

入力データの変換処理だ。だが何への変換なのか。

月曜から水曜まで三日間、瀬川はテストを書き続けた。朝の出社から夕方まで、荻野に見られる時間帯は通常のタスク——BridgeFlowの軽微なバグ修正——を進め、荻野がフロアから離れた隙にテストを書いた。

火曜の午後。コンパイルエラーの修正をエディタで開いていると、背後に柔らかい気配があった。

「いいね、瀬川くん。その調子で頼むよ」

荻野だった。画面を覗き込むわけではない。通りすがりに一瞥しただけだ。BridgeFlowのバグ修正チケットがエディタに表示されている。荻野は満足そうに頷き、そのまま通り過ぎていった。穏やかな笑顔。管理職の日常的な巡回。だがその一言は、通常業務だけをやっていろ、という透明な枠だった。枠の内側にいる限り、荻野の笑顔は続く。

椎名は何も言わなかった。隣の席でGrafanaのダッシュボードを監視しながら、瀬川の画面をちらとも見ない。ただ火曜の昼に、缶コーヒーを一本、瀬川のデスクに置いた。

三日間で書いたテストは四十七本。そのうち @<tt>{Execute} 関数の中間処理を分離するテストが十二本。変数名の発掘が進んだ。

@<tt>{xR} は入力データのJSON変換。バイト列をパースし、構造体にマッピングしている。@<tt>{kF} はキー生成。入力のマップからユーザーIDとタイムスタンプを取り出し、一意の識別子を組み立てる。@<tt>{mT} はタイムスタンプのフォーマット変換。Unix時間をISO 8601に変える。

表のデータフローが見えてきた。ユーザーのAPIリクエストを受け取り、処理し、レスポンスを返す。BridgeFlowの正規の処理パイプラインだ。

水曜の午後。@<tt>{Execute} 関数の末尾にたどり着いた。

レスポンスを返す処理の後に、もう一つの処理がある。@<tt>{return} 文の手前、千九百行目付近。条件分岐に隠された関数呼び出し。

//emlist[][go]{
if len(xR) > 0 {
    bV(kF(m), mT(t), xR)
}
//}

@<tt>{bV} 関数。テストで追跡する。引数はキー、タイムスタンプ、変換済みのリクエストデータ。戻り値はない。@<tt>{void} の処理。テストの中で呼び出すと、データベース接続エラーが返る。テスト環境にはない接続先を要求している。

@<tt>{bV} の中身を読む。難読化されているが、テストで得た引数の型情報がある。関数の核心部は短かった。

//emlist[][go]{
dC.Exec(qS, kV, tV, dV)
//}

@<tt>{dC} はデータベース接続。@<tt>{qS} はSQLクエリ文字列。定数を追跡する。

//emlist[][go]{
const qS = "INSERT INTO _shadow_logs (key, timestamp, payload) VALUES (?, ?, ?)"
//}

@<tt>{_shadow_logs}。

その名前を画面に見たとき、呼吸が止まった。

ERD図を開いた。BridgeFlowのデータベーススキーマ。テーブルは二十三個。@<tt>{users}、@<tt>{organizations}、@<tt>{tasks}、@<tt>{workflows}——@<tt>{_shadow_logs} はどこにもない。マイグレーションファイルを検索した。ゼロ件。Confluenceのデータベース設計書。記載なし。

公式のスキーマに存在しないテーブル。

//hr

水曜日の夕方。フロアの人影が減り始めた時間帯に、瀬川は本番データベースに接続した。

ステージング環境ではない。開発用DBでもない。本番の、三万社のユーザーが今まさに使っているBridgeFlowのデータベースだ。入社時に配布された認証情報で接続できる。新人にこのレベルのアクセス権があること自体が本来なら問題だが、今はそれを問う余裕がない。

ターミナルにSQLを打ち込んだ。

//emlist[][sql]{
SELECT COUNT(*) FROM _shadow_logs;
//}

結果が返るまで〇・七秒。

//emlist{
12,847,293
//}

千二百万行。

椅子の背に体が沈んだ。画面の数字を見つめる。八桁の数字が白い背景の上に黒く並んでいる。

もう一度。

//emlist[][sql]{
SELECT COUNT(*) FROM _shadow_logs;
//}

//emlist{
12,847,311
//}

十八行増えている。クエリを実行した数秒の間に。

最新のレコードを確認した。

//emlist[][sql]{
SELECT * FROM _shadow_logs ORDER BY timestamp DESC LIMIT 5;
//}

画面にデータが表示される。@<tt>{key} カラムにはユーザーIDとセッションIDの結合文字列。@<tt>{timestamp} は現在時刻の三秒前。@<tt>{payload} カラムにはJSONデータ——APIエンドポイント、リクエストボディ、ユーザーエージェント、IPアドレス。

ユーザーがBridgeFlow上で行った操作の記録だった。クリック。入力。ページ遷移。ファイルアップロード。検索クエリ。全てのAPIリクエストが、ユーザーIDに紐付いた形で記録されている。

BridgeFlowのプライバシーポリシーのページを開いた。「当社は、サービスの品質向上のため、匿名化された利用統計を収集することがあります」。匿名化。だが @<tt>{_shadow_logs} にはユーザーIDがそのまま格納されている。匿名化はされていない。三万社の、数十万人のユーザーの全行動が、個人を特定可能な形で記録され続けている。

事実を整理した。

一。全APIリクエストのデータが @<tt>{_shadow_logs} にコピーされている。二。このテーブルは公式スキーマに存在しない。三。@<tt>{payload} カラムのJSONは外部送信用にフォーマット変換されている——テストで確認した @<tt>{xR} の変換処理と一致する。四。全てのコードは門倉のコミットだ。

四つの事実が指す結論は一つしかない。

ユーザーデータの不正な収集と外部送出。

モニターの光が白くぼやけた。目を擦る。目が乾いているのだと気づくまでに数秒かかった。

席を立った。コーヒーを買いに行く。いつもの動作。足が勝手に動く。エレベーターホールの自販機の前に立ち、百三十円を投入し、ブラックの缶コーヒーのボタンを押す。缶が落ちる音。取り出す。冷たい。

食堂の前を通りかかったとき、足が止まった。いや、止まったのは瀬川ではない。

食堂の入り口で、三島彩が立ち止まっていた。

経理担当の三島。きちんとしたブラウスにカーディガン。髪はひとつに束ねられ、ファイルを胸元に抱えている。いつも通りの服装だ。だが彼女の視線が瀬川に固定されている。正確には、瀬川の顔を——門倉の後任として入った人間の顔を、確かめるように見ている。

一瞬だった。三島の目が瀬川を捉え、何かを確認するように鋭くなり、そしてすぐに逸らされた。ファイルを抱える指先が白くなっているのが見えた。彼女はそのまま食堂に入っていった。足取りはわずかに速い。

缶コーヒーを握ったまま、瀬川はその背中を見送った。指先に金属の冷たさが伝わっている。門倉の後任を見て、あの反応をする理由。怯えか。警戒か。それとも、門倉に起きたことを知っている人間の反応か。

自席に戻る。画面にはまだ @<tt>{_shadow_logs} のクエリ結果が残っていた。

//hr

水曜の夜。二十一時を過ぎた。

フロアの蛍光灯は半分が消灯し、残った光がデスクの列を薄く照らしている。残業しているのは瀬川と、数席離れた椎名だけだった。他の全員が退社した後の静けさの中で、空調の低い唸りだけが続いている。

瀬川はターミナルに @<tt>{git blame} を打ち込んだ。

//emlist[][bash]{
git blame --line-porcelain legacy/core/processor.go | grep "^author-time" | sort
//}

コミット時刻のリストが画面を埋めていく。UNIXタイムスタンプを人間が読める形式に変換する。

//emlist[][bash]{
git blame --line-porcelain legacy/core/processor.go | \
  grep "^author-time" | \
  awk '{print strftime("%Y-%m-%d %H:%M", $2)}' | sort
//}

結果が流れた。

//emlist{
2020-12-03 02:17
2020-12-03 02:34
2020-12-05 03:11
2020-12-08 02:45
2020-12-12 03:02
2021-01-07 02:22
2021-01-07 02:58
2021-01-14 03:41
...
//}

午前二時。三時。二時半。三時四十分。二時十五分。

スクロールした。画面が流れていく。何百行ものコミット時刻。ほぼ全てが深夜二時から四時の間に収まっている。

比較のために、門倉の通常業務のコミットを確認した。

//emlist[][bash]{
git log --author="Kadokura" --format="%ai" -- internal/ | \
  awk '{print $2}' | cut -c1-2 | sort | uniq -c | sort -rn
//}

//emlist{
   347 10
   312 11
   298 14
   276 15
   251 09
   243 16
   198 17
   ...
//}

@<tt>{/internal/} ディレクトリ——BridgeFlowの正規ビジネスロジック——のコミットは午前九時から午後五時に均等に分布している。普通のエンジニアの勤務時間だ。

だが @<tt>{/legacy/core/} だけが深夜に偏っている。四年間。門倉は昼に通常業務のコードを書き、夜中に @<tt>{/legacy/core/} のコードを書いていた。

コミットメッセージの時系列変化を確認した。

//emlist[][bash]{
git log --author="Kadokura" --format="%ai %s" -- legacy/core/ | tail -30
//}

初期のメッセージ。

//emlist{
2020-11-18 02:34 feat: add data collection pipeline for analytics
2020-11-25 03:12 refactor: restructure payload serialization
2020-12-03 02:17 fix: handle null values in user session data
//}

几帳面なConventional Commits。機能の追加、リファクタリング、バグ修正。コミットメッセージだけ見れば、何の問題もない開発履歴だ。

一年目の後半。

//emlist{
2021-06-14 02:51 update collection logic
2021-08-22 03:05 adjust payload format
2021-10-03 02:38 modify export config
//}

接頭辞が消えた。メッセージが短くなり、曖昧になっている。何を変えたのか、コミットメッセージだけでは分からない。

二年目以降。

//emlist{
2022-03-17 03:22 fix
2022-05-01 02:44 fix
2022-07-19 03:38 fix
2022-09-28 02:15 fix
//}

@<tt>{fix}。ただそれだけ。二年目から三年目にかけて、コミットメッセージは三文字に縮退した。何を修正したのか。三文字はそれ以上何も語らない。

そして最後。

//emlist{
2024-03-15 03:47 // ここまで読んだなら、もう引き返せない
2024-04-12 02:56 a1b2c3d もう戻れない
//}

四年間のコミット履歴。几帳面な記録が崩壊し、三文字に縮退し、最後にコードの中と同じ言葉が繰り返される。

四年分のコミットログは門倉律の精神状態のグラフだった。

画面から目を離した。天井の蛍光灯が白い光を落としている。指先が冷えている。缶コーヒーはとうに空になっていた。

椎名がキーボードから手を離す音が聞こえた。静かなフロアでは、小さな音がよく響く。

//hr

木曜日。朝。

会議室が空いている時間を確認し、椎名をチャットで呼び出した。

九時十五分。会議室Cのドアを閉める。ホワイトボードの前に立った瀬川に、椎名はパイプ椅子に座ったまま顎を上げた。

「聞く」

瀬川は画面のスクリーンショットを見せた。@<tt>{_shadow_logs} のクエリ結果。千二百万行。タイムスタンプ。ペイロード。ユーザーID。

椎名の表情は変わらなかった。スクリーンショットを三枚、順に見ていく。四枚目——コミット時刻の分布——で、顎を引いた。

「深夜だけか」

「二時から四時に集中しています。通常業務のコミットは九時から十七時です」

椎名はスクリーンショットをもう一度見た。指で画面の隅をなぞる。

「外山の来社日。ログを突き合わせたか」

瀬川は首を振った。まだそこまで手が回っていない。

「外山が来る日に本番DBへの不審なアクセスがある。半年分追ってる」椎名の声は低く、抑揚がない。事実を述べているだけの口調。「VPN経由。セキュリティコンサルタントが本番DBに直接つなぐ理由がない」

「半年前から監視していたんですか」

椎名は答えなかった。代わりに別のことを言った。

「外山の監査レポート。毎回『問題なし』だ。一年分見た。セキュリティ監査で毎回問題なしなんてことがあるか」

なかった。前職のスタートアップでも、外部監査は必ず何かしらの指摘事項を出す。全くの「問題なし」は、監査を実施していないか、問題を見ないことにしているかのどちらかだ。

瀬川は椎名を見た。椎名は窓の外に目を向けている。曇り空だ。六月の重たい雲が低く垂れ込めている。

「半年前から気づいていたのに、一人で」

「証拠がなかった」椎名が窓から視線を戻す。「ネットワーク側のログだけじゃ足りない。コードの中に何があるかを読める人間がいなかった」

会議室の空調が低く鳴っている。蛍光灯のかすかな電子音。二人の間の沈黙は短かったが、その数秒の間に何かが確定した。

椎名が立ち上がった。

「俺のログと、お前のコード解析。突き合わせるぞ」

//hr

木曜日の午後。

自席に戻った瀬川は、@<tt>{_shadow_logs} のリアルタイム監視を続けていた。ターミナルで数分おきにカウントクエリを実行する。数字は着実に増えている。三万社のユーザーが業務でBridgeFlowを使うたびに、全ての操作が @<tt>{_shadow_logs} に流れ込む。

十四時二十分。背後に気配があった。

「瀬川さん、何見てるんすか？」

佐々木遼の声。軽い調子。いつもの人懐っこさ。だが瀬川の指は反射的にターミナルのタブを切り替えていた。画面がGrafanaのダッシュボードに変わる。

振り返る。佐々木が瀬川の椅子のすぐ後ろに立っている。距離が近い。

「パフォーマンスチューニングのベンチマーク」

嘘をついた。言葉が自然に出たことに自分で驚く。

佐々木は画面を見た。Grafanaのグラフ。問題のないレスポンスタイムの推移。

「あー、なるほどっすね。レガシーコード、重いっすもんね」

笑って自席に戻っていく。だがその直前——画面を見た瞬間、佐々木の目がGrafanaの上ではなく、タスクバーに残ったターミナルのアイコンに向けられたのを、瀬川は見逃さなかった。タブを切り替える前の画面に @<tt>{SELECT COUNT(*) FROM _shadow_logs} の文字列が表示されていた時間は、一秒に満たない。佐々木がそれを読めたかどうかは分からない。

分からないが、視線の動きは確かだった。

キーボードに手を戻した。指先の温度が下がっている。

//hr

木曜日。二十時。

退社して最寄り駅までの道を歩く。六月の夜気は湿っていて、シャツの背中に張りつく。街灯の光が濡れたアスファルトに反射している。

電車に乗った。帰宅ラッシュは過ぎている。座席に座り、吊り革の揺れを見つめながら、一人一人の顔を頭の中に並べた。

椎名。半年前からネットワーク異常を追い、外山のアクセスログを保全している。今朝、コードとログを突き合わせると言った。信用できる。おそらく。

黒木。CTOでありながらGitHubのコミットが一年以上止まっている。瀬川をlegacy/coreのコミットログを見つめている最中に三秒間見ていた。何を知っていて、何を待っているのか。分からない。

荻野。「動いてるから触るな」。@<tt>{_shadow_logs} に流れ込むデータは三万社のユーザーの全行動記録だ。それを四年間放置した——あるいは意図的に維持した開発部長。門倉に深夜のコミットを強いた人物。その可能性がある。

電車が駅に停まった。ドアが開き、湿った風がホームから吹き込む。数人が降り、誰も乗ってこない。ドアが閉まる。

外山。セキュリティコンサルタント。VPN経由の本番DBアクセス。コピペの監査レポート。荻野との親密な距離。

三島。食堂の前で一瞬だけ見せた鋭い視線。あれは何だったのか。門倉の後任として入った人間を見たときの反応。怯えなのか。警戒なのか。

佐々木。タスクバーのターミナルアイコンに走った視線。パフォーマンスチューニングのベンチマークという嘘を、あの笑顔の下でどう処理したのか。入社二週間で社内事情に詳しすぎる男。最も読めない。

電車が揺れた。車窓の外を夜景が流れていく。ガラスに自分の顔が薄く映っている。

門倉もこうやって帰りの電車で考えていたのだろうか。一人一人の顔を思い浮かべ、誰を信用できるかを測り、答えが出ないまま深夜のコードに向かう。四年間。毎日。

人間は裏切る。だがコードは裏切らない。テストを書けば、コードは正直に答える。入力と出力の関係は嘘をつけない。@<tt>{_shadow_logs} はそこにあった。千二百万行。リアルタイムで増え続けている。コードが教えてくれた事実だ。

自宅に着いた。靴を脱ぎ、スーツのジャケットを椅子の背にかけ、私用のラップトップを開いた。

今日記録したスクリーンショットとメモを整理する。コミット時刻の分布。@<tt>{_shadow_logs} の行数推移。@<tt>{bV} 関数の解析結果。椎名から聞いた外山のアクセスログ。散らばった事実を一つのディレクトリにまとめていく。

止めなければならない。今この瞬間も、データは増え続けている。三万社のユーザーが何も知らないまま、全ての操作を記録されている。

だがどうやって。

一人のバックエンドエンジニアに何ができる。コードを読んだ。テストを書いた。テーブルを見つけた。コミット時刻を調べた。それで。その先に何がある。

ラップトップを閉じた。

ベッドに横になる。天井が暗い。スマートフォンの画面を確認する。二十三時四十分。目を閉じる。

眠れなかった。

暗い天井を見上げたまま、時間が過ぎていく。何度か寝返りを打った。コミット時刻のリストが頭の中で再生される。二時十七分。三時十一分。二時四十五分。三時二分。

午前一時。

一時半。

二時になった。

門倉はこの時間にコードを書いていた。四年間。毎晩。自宅のラップトップか、あるいは誰もいないオフィスで、@<tt>{_shadow_logs} にデータを流し込むコードを書き、難読化し、コミットし、朝が来たら何事もなかったように出社する。

千四百六十日。

暗闇の中でスマートフォンの画面が光った。時刻表示。午前二時三分。

門倉がコミットしていた時間。瀬川が眠れずにいる時間。二人の時間が重なっている。

@<tt>{_shadow_logs} は今も増えている。
