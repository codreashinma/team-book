= 第02章: // DO NOT TOUCH

七時十五分。人感センサーが反応し、天井の蛍光灯がカチ、カチ、と順番に点いていく。瀬川の歩みに合わせて光が追いかけてくるような、妙な感覚だった。フロアには誰もいない。昨日四十人のエンジニアがキーボードを叩いていた空間が、今は空調の低い唸りだけを響かせている。

デスクに着く。HHKBの電源を入れ、モニターが青白く立ち上がるのを待つ間に、ジャケットのポケットから黒い小さなものを取り出した。

USBメモリ。油性ペンの「開けるな」。

昨夜、帰宅して私用のラップトップに挿した。ファイルは一つだけだった。

//emlist{
$ ls -la /media/usb/
total 4
-rw-r--r-- 1 segawa segawa 2048 Apr 15 17:58 truth.enc
//}

@<tt>{.enc}。暗号化ファイル。OpenSSLの形式に見える。パスワードを何パターンか試した。@<tt>{kadokura}、@<tt>{bridgeflow}、@<tt>{legacy}、@<tt>{password}——すべて同じ結果だった。

//emlist{
bad decrypt
//}

復号できない。鍵が分からない。USBメモリをデスクの引き出しに戻した。文房具の奥に転がり、クリップの箱にぶつかって小さな音を立てる。

鍵は後で考える。まずはコードを読む。

//hr

ターミナルを開き、@<tt>{bridgeflow-api} のディレクトリ構造を改めて確認した。昨日は @<tt>{internal/} 以下を読んでいた。Goのレイヤードアーキテクチャとしては標準的な構成——@<tt>{handler/}、@<tt>{service/}、@<tt>{repository/}。パッケージの分割に迷いはない。だが、コメントの不在と曖昧な関数名が全体を不透明にしている。

ディレクトリのリストを端から端まで眺める。@<tt>{cmd/}、@<tt>{configs/}、@<tt>{internal/}、@<tt>{migrations/}、@<tt>{pkg/}——そして、一つだけ異質なディレクトリがあった。

//emlist{
legacy/
└── core/
    ├── aggregator.go
    ├── bridge.go
    ├── collector.go
    ...
    └── worker.go
//}

@<tt>{/legacy/core/}。@<tt>{internal/} の外にある。Goプロジェクトで @<tt>{legacy} という名前のトップレベルディレクトリは見たことがない。ファイル数を数える。

//emlist{
$ find legacy/core -name "*.go" | wc -l
37
//}

三十七ファイル。行数を確認する。

//emlist{
$ find legacy/core -name "*.go" -exec cat {} + | wc -l
20,314
//}

約二万行。リポジトリ全体が十万三千行だから、五分の一がこのディレクトリに詰まっている計算になる。

最初のファイルを開いた。@<tt>{aggregator.go}。

一行目。

//emlist[][go]{
// DO NOT TOUCH - K
//}

コメント。@<tt>{K}。門倉律のイニシャルだろうか。二行目以降に目を移す。

//emlist[][go]{
func aG(d []byte, t int64) ([]byte, error) {
    var r []byte
    for i := 0; i < len(d); i++ {
        v := d[i] ^ byte(t>>uint(i%8))
        r = append(r, v)
    }
    return r, nil
}
//}

変数名は一文字か二文字。@<tt>{aG}、@<tt>{d}、@<tt>{t}、@<tt>{r}、@<tt>{v}。関数名から処理内容を推測する手がかりがない。XOR演算を使ったバイト操作に見えるが、何のための処理なのかはコンテキストなしには判断できない。

次のファイル。@<tt>{bridge.go}。

//emlist[][go]{
// DO NOT TOUCH - K
//}

一行目。同じコメント。

@<tt>{collector.go}。

//emlist[][go]{
// DO NOT TOUCH - K
//}

同じだ。

一つずつ開いた。@<tt>{dispatcher.go}。@<tt>{encoder.go}。@<tt>{filter.go}。@<tt>{gateway.go}。途中からターミナルに切り替えた。

//emlist{
$ head -1 legacy/core/*.go
//}

三十七ファイル分の一行目が並ぶ。すべて同じだった。

//emlist{
==> legacy/core/aggregator.go <==
// DO NOT TOUCH - K

==> legacy/core/bridge.go <==
// DO NOT TOUCH - K

==> legacy/core/collector.go <==
// DO NOT TOUCH - K
//}

例外は一つもない。三十七ファイル。二万行。すべての先頭に、同じ五語が刻まれている。

触れるな——K。

コードの中身に戻る。変数名は一文字から二文字の略語だけで構成されている。関数名も同様だ。@<tt>{pR}、@<tt>{sX}、@<tt>{dN}。推測の手がかりが一つもない。通常のレガシーコードなら、少なくとも変数名に元の意図の断片が残る。@<tt>{usr} なら user、@<tt>{cnt} なら count。だがこのコードにはそれすらない。まるで——意図的に読めなくしたかのように。

//hr

「触らない方がいい」

九時を過ぎた頃、コーヒー片手に椎名が出社した。瀬川のモニターを一瞥して、抑揚のない声で言った。

「@<tt>{/legacy/core/} のコードなんですが——」

「触らない方がいい」

言い終わる前に返ってきた。椎名はコーヒーを自分のデスクに置き、椅子に座った。Grafanaのダッシュボードが画面に復帰する。

「半年前、外注のエンジニアが二人入った。あのディレクトリのリファクタリングを試みた」

椎名はダッシュボードの波形に目を落としたまま続けた。

「三日目でステージングが全壊した。テストがないから、何が壊れたかも分からない。門倉が一人で復旧した。二週間かかった」

手がキーボードの上で止まっていた。

「門倉はその二週間、ほとんど寝ていなかったはずだ。コミットログの時刻を見れば分かる」

それだけ言って、椎名は会話を終わらせた。

昼前、荻野がフロアを巡回してきた。瀬川のデスクの横で立ち止まる。モニターに @<tt>{legacy/core/} のコードが表示されているのが見えたはずだった。

「まあ、動いているものに手を入れる必要はないよね」

笑顔だった。面接の時と同じ、穏やかな笑顔。声は柔らかい。

「瀬川くん、まずはBridgeFlowの通常運用をしっかり覚えてくれるかな。@<tt>{legacy} は動いてるんだから触らなくていい。それがうちのルールだよ」

そう言って、次のデスクへ移っていった。

動いてるから触るな。

確かに動いている。ただし、何をしているのか、誰にも分からない状態で。

//hr

水曜日の昼。佐々木が弁当を持って近づいてきた。

「瀬川さん、一緒にメシどうっす」

社食のテーブルで向かい合う。佐々木は焼き鮭弁当のフタを開けながら、周囲に軽く視線を配った。フロアからは離れた場所だ。近くのテーブルに人はいない。

「てか瀬川さん、知ってました？ 黒木CTOのGitHub、最後のコミットが一年以上前なんすよ」

箸が止まった。

「なんで調べたんですか」

「あー、いやー、なんとなく。入社したらCTOってどんな人かなって思うじゃないですか。で、GitHub見たら、パブリックリポジトリがいくつかあって。アーキテクチャ関連のツールとか、結構ちゃんとしたやつ。でも最新のコミットが去年の四月で止まってる」

CTOがコードを書かなくなったのは珍しいことではない。マネジメントに軸足を移すエンジニアは多い。だがフロントエンドエンジニアが入社二週間目でCTOのGitHub履歴まで調べている——それは、なんとなくで説明がつくのだろうか。

佐々木は鮭をほぐしながら何でもないように続けた。

「あと、外注エンジニアがリファクタリングで失敗したって話、瀬川さんも聞きました？ あれ、その後二人ともすぐ契約切られたらしいっすよ」

午後。自席に戻り、ターミナルを開いた。

//emlist{
$ git log --oneline --date-order -- legacy/core/
//}

@<tt>{/legacy/core/} に絞ったコミット履歴が表示される。最新のコミットは約二ヶ月前——四月十四日。門倉が消える前日だった。

コミットメッセージの一覧をスクロールしていく。整然としていた。すべてConventional Commitsの形式に従っている。@<tt>{feat:} で始まる機能追加、@<tt>{fix:} のバグ修正、@<tt>{refactor:} のリファクタリング。四年分のコミット履歴が、一つの例外もなくフォーマットを守り続けている。一人で、四年間。

最新のコミットまでスクロールした。

//emlist{
a1b2c3d もう戻れない
//}

Conventional Commitsのプレフィックスがない。@<tt>{feat:} も @<tt>{fix:} も @<tt>{refactor:} もない。四年間一度も崩さなかったルールを、最後のコミットでだけ破っている。

もう戻れない。

メッセージの意味を考えようとした。コードの変更内容なのか。門倉自身の状態なのか。それとも——

視線を感じた。

顔を上げる。フロアの奥、窓際の席。黒木洋介がこちらを見ていた。モニターに映るコミットログの画面は、この距離からは読めないはずだ。だが黒木の目は瀬川のモニターではなく、瀬川自身を見ている。

目が合った。一秒。二秒。三秒目に、黒木は視線を逸らした。深い隈に縁取られた目が、またどこか遠くを見つめる。

キーボードに手を戻した。指先が冷えていた。

//hr

木曜日。午前二時十三分。

スマートフォンの振動で目が覚めた。枕元の画面が暗い天井に白い光を投げている。PagerDutyのアラート。

//emlist{
[CRITICAL] bridgeflow-api: HTTP 500 error rate exceeds threshold (>5%) - production
//}

体を起こす。ベッドサイドのスタンドライトを点けるより先に、スマートフォンの画面を開いた。Slackの通知が連なっている。

椎名からのメッセージ。二時十五分。

//emlist{
legacy/core のプロセスが暴走してる。メモリ使用率90%超。
瀬川、コード側見れるか。
//}

二時十六分。

//emlist{
俺はインフラ側を見る。プロセスの再起動で一時的に止まるが、根本原因が分からないと再発する。
//}

社用ラップトップを開いた。画面の光が暗い部屋に青白く広がる。VPN接続。本番環境のログを確認する。五百エラーが二時七分から断続的に出ている。エラーの発生源を辿る。スタックトレースが @<tt>{legacy/core/processor.go} を指していた。

触るなと言われたコードだ。

だが障害は今起きている。

@<tt>{processor.go} を開いた。

二千行。

変数名は暗号のように短い。関数がネストしている。二重、三重、四重——六重のネストに達する箇所がある。コメントは一行目の @<tt>{// DO NOT TOUCH - K} だけで、それ以降は一切ない。二千行の無注釈のGoコード。

スタックトレースが示す関数を特定した。七百行目付近の @<tt>{pR} という関数。引数は @<tt>{[]byte} と @<tt>{int64} と @<tt>{func(byte) bool} の三つ。戻り値は @<tt>{error} のみ。何をしている関数なのかは、名前からも型シグネチャからも読み取れない。

周辺のコードを読む。@<tt>{pR} は @<tt>{sX} を呼び、@<tt>{sX} は @<tt>{dN} を呼び、@<tt>{dN} は @<tt>{pR} に戻る。循環している。いや、条件分岐を追うと、ある閾値を超えた場合にだけ @<tt>{pR} に戻るパスがあり、通常のフローは @<tt>{dN} から @<tt>{wK} へ抜ける。メモリが解放されるのは @<tt>{wK} の末尾。つまり、閾値を超え続ける限りメモリが積み上がる。

パッチの方針を決めた。@<tt>{pR} の入り口にメモリ使用量のチェックを追加し、閾値を超えた場合に @<tt>{wK} へ強制的に抜けるフォールバックを書く。テストは書けない。関数が何をしているか理解できないのだから、期待する出力を定義しようがない。

椎名にSlackで報告した。

//emlist{
pR関数でメモリリークを確認。フォールバック追加で対応可能。テストなし。
//}

返事は一行だった。

//emlist{
やってくれ。
//}

パッチを書き、ステージングで確認し、本番にデプロイした。三時二十二分。エラーレートが下がり始める。三時三十分にはゼロに戻った。

障害は収まった。だが、モニターの前から動けなかった。

@<tt>{processor.go} のコードが画面に残っている。パッチを当てた周辺を読み返す。七百行目から八百行目。九百行目。千行目。読み進めるにつれ、ある確信が強くなっていった。

このコードは、ただ古いだけのレガシーコードではない。

千二百行目付近。十六進数のマジックナンバーが埋め込まれていた。

//emlist[][go]{
const mK = 0x5DEECE66D
//}

@<tt>{0x5DEECE66D}。この数値を知っている。Javaの @<tt>{java.util.Random} の内部定数だ。なぜGoのコードに。

周辺のコードを読む。@<tt>{mK} は乗算とXOR演算に使われ、入力バイト列を変換している。Javaの乱数生成器のロジックを、意図的にGoへ移植している。コードの意味を隠すためだけに、他言語の仕様を持ち込んでいる。

通常のレガシーコードは、時間の経過とともに意図が失われる。だがこのコードは違う。最初から意図を隠すために書かれている。難読化。それも、機械的な難読化ではなく、人間が手作業で施した難読化だ。

千五百行目。千六百行目。コードの密度が増していく。変数名はさらに短くなり、一文字の @<tt>{a}、@<tt>{b}、@<tt>{c} が入り乱れる。関数の呼び出しチェーンは十段以上に及び、制御フローの全体像を頭の中に保持するのが困難になってくる。

千八百行目を過ぎた頃だった。

コメントアウトされた一行が、コードの間に挟まっていた。

//emlist[][go]{
// ここまで読んだなら、もう引き返せない
//}

画面を凝視した。時刻は四時を回っていた。窓の外はまだ暗い。部屋にはスタンドライトとモニターの光だけがあり、自分の呼吸の音が聞こえる。

門倉律はこの一行を、二千行のコードの千八百行目に埋めた。ここまで読む人間がいることを想定して。一行目の @<tt>{// DO NOT TOUCH - K} を無視して、二千行を読み解く人間が現れることを。

もう引き返せない。

門倉は知っていた。このコードが何であるかを。なぜ難読化されているかを。そして、いつか誰かがここまで辿り着くことを。

@<tt>{git blame} で確認する。その一行のコミット日時は三月十五日。門倉が消える一ヶ月前だった。

ラップトップを閉じた。部屋が暗くなる。目を閉じると、コードの文字列が瞼の裏に残像のように浮かんでいた。

//hr

金曜日。出社すると、フロアの空気がどこか違った。

いつもと同じ蛍光灯の光。同じ空調の唸り。同じ打鍵音。だが瀬川が自席に向かう途中、荻野のデスクの近くに見慣れない背中があった。

がっちりした体格の男が、荻野と並んで立っている。五十代。紺色のスーツは仕立てが良く、銀色のカフスが袖口から覗いている。荻野と何か談笑していて、低い笑い声がフロアに響いた。荻野がこんなに親しげに笑う相手を、瀬川は初めて見た。

自席に着く。椎名はすでにGrafanaの前にいた。昨夜の障害対応で寝不足のはずだが、表情はいつもと変わらない。

佐々木が後ろから声をかけてきた。声を落としている。

「瀬川さん、あの人。外山健一さん。セキュリティコンサルタントっすよ。年に二回、外部監査で来るんだって」

入社二週間の佐々木が知っている情報。

荻野と外山が瀬川のデスクの前を通りかかった。外山が足を止める。営業スマイル。整った笑顔の奥で、目だけが値踏みするように瀬川を見た。微かにコロンの残り香が漂う。

「いやあ、あなたが門倉さんの後任なんですね」

外山は右手を差し出した。握手。手のひらは乾いていて、握力は必要以上に強かった。

「大変でしょう。あれだけのコードを引き継ぐのは」

門倉を過去形で語る。「いた人」ではなく「いない人」として。二ヶ月前に連絡が取れなくなった人間を、外部のコンサルタントがそう扱う。それが自然なのか不自然なのか、入社五日目の瀬川にはまだ判断がつかない。

「セキュリティは日々進化しますからね。何かあったらいつでも相談してください」

そう言って、外山は荻野と共にフロアの奥へ消えていった。二人の距離が近い。上司と外部コンサルタントというよりも、古い付き合いの仕事仲間のような親密さだった。

自席に座る。障害レポートの下書きを画面に表示した。昨夜の対応——@<tt>{processor.go} のメモリリーク、@<tt>{pR} 関数のフォールバック追加、三時二十二分のデプロイ。事実を淡々と記述していく。

指が止まった。

障害レポートの画面を見ている。だが頭の中では、全く別のコードが回っている。

三十七ファイルの一行目。@<tt>{// DO NOT TOUCH - K}。意図的な難読化。Javaのランダム定数。六重のネスト。そして千八百行目に埋められた一行。

門倉律は何を隠したのか。なぜ難読化したのか。そして——なぜ消えたのか。

あのコードを読む。最後まで。

@<tt>{a1b2c3d もう戻れない}。

門倉の言葉は正しかった。もう引き返せない。
